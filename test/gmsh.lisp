(in-package #:gmsh-tests)

(plan 1)

(subtest "gmsh" (veq:fvprogn
  (let ((msh (gmsh:gmsh :max-verts 100)))
    (gmsh:add-vert! msh 1f0 2f0 3f0)
    (gmsh:add-vert! msh 3f0 3f0 4.330)
    (gmsh:add-vert! msh 4f0 2f0 4.0)
    (gmsh:add-vert! msh 9f0 7f0 4.30)
    (is (gmsh:add-poly! msh '(2 0 1)) '(0 1 2))
    ; (is-warning (gmsh:add-poly! msh '(2 0 1))) ; TODO
    (is-error (gmsh:add-poly! msh '(3 3 1)) 'simple-error)
    (is (gmsh:add-poly! msh '(1 2 3)) '(1 2 3))
    (is (gmsh:add-poly! msh '(1 0 3)) '(0 3 1))
    (is (gmsh:get-all-polys msh) '((0 1 2) (1 2 3) (0 3 1)))
    (is (gmsh:del-poly! msh '(1 0 3)) nil) ; only delets literal poly matches
    (is (gmsh:del-poly! msh '(0 3 1)) '(0 3 1))
    (is (gmsh:get-all-polys msh) '((0 1 2) (1 2 3)))

    (is (gmsh:get-connected-verts msh) '(0 1 2 3))
    (is (veq:lst (gmsh:get-vert msh 2)) '(4.0 2.0 4.0))
    (is-arr (gmsh:get-verts msh '(2 3)) #(4.0 2.0 4.0 9.0 7.0 4.3)))))


(subtest "gmsh bvh nodes" (veq:fvprogn
   (let* ((msh (gmsh/io:obj/load-model :cube))
         (lmsh (gmsh/io:obj/load-model :teapot))
         (bvh (gmsh:make-bvh msh :num 2 :mode :bvh2-stackless :sort-num 7))
         (bvh4-simd (gmsh:make-bvh lmsh :num 3 :mode :bvh4-simd :sort-num 7)))

(is-arr (gmsh:get-verts msh (list 2 1 2 4 7 6))
        #(-1.0 -1.0 1.0 1.0 -1.0 1.0 -1.0 -1.0 1.0 1.0 1.0 -1.0 -1.0 1.0 -1.0
               -1.0 1.0 1.0))
    (is (gmsh:get-all-polys msh)
        '((1 2 3) (5 7 6) (1 4 5) (2 5 6) (2 6 7) (0 3 7)
          (0 1 3) (4 7 5) (0 4 1) (1 5 2) (2 7 3) (0 7 4)))
    (is (gmsh:add-poly! msh '(7 6 0)) '(0 7 6))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh) 0 32))
            #(-1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 -1.0 -1.0 1.0 -1.0 1.0
                   0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0
                   -1.0 1.0 0.0 0.0 1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0
                   -1.0 -1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0
                   0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0
                   -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0
                   -1.0 1.0 -1.0 -1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0
                   0.0))

    (is-arr (gmsh/bvh::bvh-int-nodes bvh)
            #(0 4 0 0 2 9 0 8 0 12 0 0 0 20 1 16 2 99 0 0 2 27 0 24 0 28 0 16 0
                36 0 32 0 44 0 16 2 45 0 40 1 63 0 32 2 72 0 48 1 90 0 16))

    (is-arr (p3.@$identity (?@ (gmsh/bvh::bvh-int-nodes bvh4-simd) 0 128))
            #(0 4 0 0 0 12 1 8 0 13844 0 0 0 20 0 16 0 7860 1 8 0 28 0 24 0
                3284 1 16 0 36 1 32 0 2412 1 24 0 44 1 40 0 1316 0 32 0 52 0 48
                0 540 1 40 0 60 2 56 0 268 0 48 0 68 2 64 0 188 0 56 0 76 0 72
                0 156 0 64 0 84 1 80 0 108 2 72 0 92 1 88 0 100 1 80 2 9 0 96 2
                27 0 88 3 45 0 104 3 72 0 80 0 116 1 112 0 140 0 72 0 124 1 120
                0 132 1 112 2 99 0 128 2 117 0 120 2 135 0 136 2 153 0 112 0
                148 0 144 3 207 0 72 2 171 0 152 2 189 0 144 0 164 0 160 0 180
                2 64 3 234 0 168 0 172 2 160 2 261 0 176 2 279 0 160 2 297 0
                184 2 315 0 64 0 196 0 192 0 220 1 56 0 204 1 200 0 212 0 192 2
                333 0 208 2 351 0 200 2 369 0 216 3 387 0 192 0 228 0 224 0 252
                0 56 0 236 0 232 0 244 0 224 2 414 0 240 2 432 0 232 2 450 0
                248 3 468 0 224 3 495 0 256 0 260 1 56 2 522 0 264 2 540 0 56 0
                276 2 272 0 412 2 48 0 284 2 280 0 348 2 272 0 292 1 288 0 316
                1 280 0 300 1 296 0 308 1 288 3 558 0 304 3 585 0 296 3 612 0
                312 3 639 0 288 0 324 0 320 0 332 0 280 2 666 0 328 2 684 0 320
                3 702 0 336 0 340 2 280 2 729 0 344 2 747 0 280 0 356 1 352 0
                380 1 272 0 364 0 360 0 372 1 352 2 765 0 368 2 783 0 360 3 801
                0 376 3 828 0 352 0 388 0 384))

    (is-arr (p3.@$identity (?@ (gmsh/bvh::bvh-simd-nodes bvh4-simd) 0 128))
            #(0 0 0 0 1 2 3 4 0 0 0 0 861 862 863 864 0 0 0 0 486 487 488 489 0
                0 0 0 151 152 153 154 0 0 0 0 5 6 7 8 0 0 0 0 130 131 132 133 0
                0 0 0 110 111 112 113 0 0 0 0 90 91 92 93 0 0 0 0 9 10 11 12 0
                0 0 0 69 70 71 72 0 0 0 0 52 53 54 55 0 0 0 0 31 32 33 34 0 0 0
                0 13 14 15 16 3 3 0 0 56034 56061 29 30 3 0 3 0 56169 27 56250
                28 0 0 0 0 21 22 23 24 0 0 3 0 17 18 56790 19 2 0 2 0 56664 0
                56682 0 2 0 3 0 56700 0 56718 20 2 0 3 3 56817 0 56835 56862 2
                0 3 0 56745 0 56763 0 2 2 2 2 56331 56349 56367 56385 3 0 3 0
                56403 0 56430 0 3 0 3 0 56457 0 56484 26 2 3 2 0 56556 56574
                56601 25 2 0 3 0 56619 0 56637 0 2 0 3 0 56511 0 56529 0 3 0 3
                0 56196 0 56223 0 3 0 3 0 56277 0 56304 0 2 0 2 0 56088 0 56106
                0 2 0 3 0 56124 0 56142 0 3 0 2 0 55089 48 55152 49 0 0 0 0 42
                43 44 45 0 0 0 3 39 40 41 55710 0 0 0 0 35 36 37 38 3 0 3 0
                55737 0 55764 0 3 0 3 0 55791 0 55818 0 2 2 2 3 55845 55863
                55881 55899 3 3 3 3 55926 55953 55980 56007 3 0 3 0 55539 0
                55566 0 2 2 2 3 55593 55611 55629 55647 2 0 2 0 55674 0 55692 0
                3 0 3 0 55269 0 55296 0 3 0 3 0 55323 0 55350 0 2 2 0 0 55377
                55395 46 47 2 0 3 0 55494 0 55512 0 2 0 2 0 55413 0 55431 0 2 0
                3 0 55449 0 55467 0))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh4-simd) 0 64))
            #(-3.0 3.434 0.0 3.15 -2.0 2.0 0.0 0.0 -3.0 0.6049 0.0 3.15 -2.0
                   2.0 0.0 0.0 0.310439 3.434 0.002175 2.5974 -1.97424 1.97424
                   0.0 0.0 -3.0 0.6049 0.0 2.435437 -2.0 2.0 0.0 0.0 -1.480325
                   0.557774 2.4 3.15 -1.480325 1.480325 0.0 0.0 -3.0 -1.55
                   0.3168 2.24955 -1.18784 1.18784 0.0 0.0 -1.79295 0.6049 0.0
                   2.435437 -2.0 2.0 0.0 0.0 -3.0 -1.989107 0.703463 2.2464
                   -0.225 0.225 0.0 0.0 -2.158645 -1.55 0.3168 2.24955 -1.18784
                   1.18784 0.0 0.0 -3.0 -2.11305 0.703463 1.8 -0.225 0.225 0.0
                   0.0 -3.0 -1.989107 1.8 2.2464 -0.225 0.225 0.0 0.0 -2.8288
                   -2.11305 0.703463 1.285171 -0.225 0.225 0.0 0.0 -3.0 -2.4624
                   1.163194 1.8 -0.225 0.225 0.0 0.0 -2.8288 -2.374406 0.922987
                   1.285171 -0.225 0.225 0.0 0.0 -2.46835 -2.11305 0.703463
                   1.2492 -0.225 0.225 0.0 0.0 -2.8288 -2.381752 0.922987
                   1.285171 -0.225 0.081 0.0 0.0 -2.725825 -2.374406 0.929375
                   1.253906 0.081 0.225 0.0 0.0 -2.725825 -2.381752 0.929375
                   1.28235 -0.225 -0.081 0.0 0.0 -2.8288 -2.465644 0.922987
                   1.285171 -0.081 0.081 0.0 0.0 -2.725825 -2.514778 1.044497
                   1.28235 -0.225 -0.081 0.0 0.0 -2.607034 -2.381752 0.929375
                   1.243303 -0.225 -0.081 0.0 0.0 -2.725825 -2.579059 1.044497
                   1.199325 -0.189 -0.081 0.0 0.0 -2.6894 -2.514778 1.08409
                   1.28235 -0.225 -0.189 0.0 0.0 -2.725825 -2.595725 1.044497
                   1.1778 -0.144 -0.081 0.0 0.0))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh4-simd) 0 64))
            #(-3.0 3.434 0.0 3.15 -2.0 2.0 0.0 0.0 -3.0 0.6049 0.0 3.15 -2.0
                   2.0 0.0 0.0 0.310439 3.434 0.002175 2.5974 -1.97424 1.97424
                   0.0 0.0 -3.0 0.6049 0.0 2.435437 -2.0 2.0 0.0 0.0 -1.480325
                   0.557774 2.4 3.15 -1.480325 1.480325 0.0 0.0 -3.0 -1.55
                   0.3168 2.24955 -1.18784 1.18784 0.0 0.0 -1.79295 0.6049 0.0
                   2.435437 -2.0 2.0 0.0 0.0 -3.0 -1.989107 0.703463 2.2464
                   -0.225 0.225 0.0 0.0 -2.158645 -1.55 0.3168 2.24955 -1.18784
                   1.18784 0.0 0.0 -3.0 -2.11305 0.703463 1.8 -0.225 0.225 0.0
                   0.0 -3.0 -1.989107 1.8 2.2464 -0.225 0.225 0.0 0.0 -2.8288
                   -2.11305 0.703463 1.285171 -0.225 0.225 0.0 0.0 -3.0 -2.4624
                   1.163194 1.8 -0.225 0.225 0.0 0.0 -2.8288 -2.374406 0.922987
                   1.285171 -0.225 0.225 0.0 0.0 -2.46835 -2.11305 0.703463
                   1.2492 -0.225 0.225 0.0 0.0 -2.8288 -2.381752 0.922987
                   1.285171 -0.225 0.081 0.0 0.0 -2.725825 -2.374406 0.929375
                   1.253906 0.081 0.225 0.0 0.0 -2.725825 -2.381752 0.929375
                   1.28235 -0.225 -0.081 0.0 0.0 -2.8288 -2.465644 0.922987
                   1.285171 -0.081 0.081 0.0 0.0 -2.725825 -2.514778 1.044497
                   1.28235 -0.225 -0.081 0.0 0.0 -2.607034 -2.381752 0.929375
                   1.243303 -0.225 -0.081 0.0 0.0 -2.725825 -2.579059 1.044497
                   1.199325 -0.189 -0.081 0.0 0.0 -2.6894 -2.514778 1.08409
                   1.28235 -0.225 -0.189 0.0 0.0 -2.725825 -2.595725 1.044497
                   1.1778 -0.144 -0.081 0.0 0.0)))))

(unless (finalize) (error "error in gmsh"))

