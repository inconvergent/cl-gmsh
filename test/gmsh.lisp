(in-package #:gmsh-tests)

(plan 3)

(subtest "gmsh" (veq:fvprogn
  (let ((msh (gmsh:gmsh :max-verts 100)))
    (gmsh:add-vert! msh 1f0 2f0 3f0)
    (gmsh:add-vert! msh 3f0 3f0 4.330)
    (gmsh:add-vert! msh 4f0 2f0 4.0)
    (gmsh:add-vert! msh 9f0 7f0 4.30)
    (is (gmsh:add-poly! msh '(2 0 1)) '(0 1 2))
    ; (is-warning (gmsh:add-poly! msh '(2 0 1))) ; TODO
    (is-error (gmsh:add-poly! msh '(3 3 1)) 'simple-error)
    (is (gmsh:add-poly! msh '(1 2 3)) '(1 2 3))
    (is (gmsh:add-poly! msh '(1 0 3)) '(0 3 1))
    (is (gmsh:get-all-polys msh) '((0 1 2) (1 2 3) (0 3 1)))
    (is (gmsh:del-poly! msh '(1 0 3)) nil) ; only delets literal poly matches
    (is (gmsh:del-poly! msh '(0 3 1)) '(0 3 1))
    (is (gmsh:get-all-polys msh) '((0 1 2) (1 2 3)))

    (is (gmsh:get-connected-verts msh) '(0 1 2 3))
    (is (veq:lst (gmsh:get-vert msh 2)) '(4.0 2.0 4.0))
    (is-arr (gmsh:get-verts msh '(2 3)) #(4.0 2.0 4.0 9.0 7.0 4.3)))))


(subtest "gmsh bvh nodes" (veq:fvprogn
   (let* ((msh (gmsh/io:obj/load-model :cube))
         (lmsh (gmsh/io:obj/load-model :teapot))
         (bvh (gmsh:make-bvh msh :num 2 :mode :bvh2-stackless :sort-num 7))
         (bvh4-simd (gmsh:make-bvh lmsh :num 3 :mode :bvh4-simd :sort-num 7)))

(is-arr (gmsh:get-verts msh (list 2 1 2 4 7 6))
        #(-1.0 -1.0 1.0 1.0 -1.0 1.0 -1.0 -1.0 1.0 1.0 1.0 -1.0 -1.0 1.0 -1.0
               -1.0 1.0 1.0))
    (is (gmsh:get-all-polys msh)
        '((1 2 3) (5 7 6) (1 4 5) (2 5 6) (2 6 7) (0 3 7)
          (0 1 3) (4 7 5) (0 4 1) (1 5 2) (2 7 3) (0 7 4)))
    (is (gmsh:add-poly! msh '(7 6 0)) '(0 7 6))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh) 0 32))
            #(-1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 -1.0 -1.0 1.0 -1.0 1.0
                   0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0
                   -1.0 1.0 0.0 0.0 1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0
                   -1.0 -1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0
                   0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0
                   -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0
                   -1.0 1.0 -1.0 -1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0
                   0.0))

    (is-arr (gmsh/bvh::bvh-int-nodes bvh)
            #(0 4 0 0 2 9 0 8 0 12 0 0 0 20 1 16 2 99 0 0 2 27 0 24 0 28 0 16 0
                36 0 32 0 44 0 16 2 45 0 40 1 63 0 32 2 72 0 48 1 90 0 16))

    (is-arr (p3.@$identity (?@ (gmsh/bvh::bvh-int-nodes bvh4-simd) 0 128))
            #(0 4 0 0 0 12 1 8 0 13844 0 0 0 20 0 16 0 7860 1 8 0 28 0 24 0
                3284 1 16 0 36 1 32 0 2412 1 24 0 44 1 40 0 1316 0 32 0 52 0 48
                0 540 1 40 0 60 2 56 0 268 0 48 0 68 2 64 0 188 0 56 0 76 0 72
                0 156 0 64 0 84 1 80 0 108 2 72 0 92 1 88 0 100 1 80 2 9 0 96 2
                27 0 88 3 45 0 104 3 72 0 80 0 116 1 112 0 140 0 72 0 124 1 120
                0 132 1 112 2 99 0 128 2 117 0 120 2 135 0 136 2 153 0 112 0
                148 0 144 3 207 0 72 2 171 0 152 2 189 0 144 0 164 0 160 0 180
                2 64 3 234 0 168 0 172 2 160 2 261 0 176 2 279 0 160 2 297 0
                184 2 315 0 64 0 196 0 192 0 220 1 56 0 204 1 200 0 212 0 192 2
                333 0 208 2 351 0 200 2 369 0 216 3 387 0 192 0 228 0 224 0 252
                0 56 0 236 0 232 0 244 0 224 2 414 0 240 2 432 0 232 2 450 0
                248 3 468 0 224 3 495 0 256 0 260 1 56 2 522 0 264 2 540 0 56 0
                276 2 272 0 412 2 48 0 284 2 280 0 348 2 272 0 292 1 288 0 316
                1 280 0 300 1 296 0 308 1 288 3 558 0 304 3 585 0 296 3 612 0
                312 3 639 0 288 0 324 0 320 0 332 0 280 2 666 0 328 2 684 0 320
                3 702 0 336 0 340 2 280 2 729 0 344 2 747 0 280 0 356 1 352 0
                380 1 272 0 364 0 360 0 372 1 352 2 765 0 368 2 783 0 360 3 801
                0 376 3 828 0 352 0 388 0 384))

    (is-arr (p3.@$identity (?@ (gmsh/bvh::bvh-simd-nodes bvh4-simd) 0 128))
            #(0 0 0 0 1 2 3 4 0 0 0 0 861 862 863 864 0 0 0 0 486 487 488 489 0
                0 0 0 151 152 153 154 0 0 0 0 5 6 7 8 0 0 0 0 130 131 132 133 0
                0 0 0 110 111 112 113 0 0 0 0 90 91 92 93 0 0 0 0 9 10 11 12 0
                0 0 0 69 70 71 72 0 0 0 0 52 53 54 55 0 0 0 0 31 32 33 34 0 0 0
                0 13 14 15 16 3 3 0 0 56034 56061 29 30 3 0 3 0 56169 27 56250
                28 0 0 0 0 21 22 23 24 0 0 3 0 17 18 56790 19 2 0 2 0 56664 0
                56682 0 2 0 3 0 56700 0 56718 20 2 0 3 3 56817 0 56835 56862 2
                0 3 0 56745 0 56763 0 2 2 2 2 56331 56349 56367 56385 3 0 3 0
                56403 0 56430 0 3 0 3 0 56457 0 56484 26 2 3 2 0 56556 56574
                56601 25 2 0 3 0 56619 0 56637 0 2 0 3 0 56511 0 56529 0 3 0 3
                0 56196 0 56223 0 3 0 3 0 56277 0 56304 0 2 0 2 0 56088 0 56106
                0 2 0 3 0 56124 0 56142 0 3 0 2 0 55089 48 55152 49 0 0 0 0 42
                43 44 45 0 0 0 3 39 40 41 55710 0 0 0 0 35 36 37 38 3 0 3 0
                55737 0 55764 0 3 0 3 0 55791 0 55818 0 2 2 2 3 55845 55863
                55881 55899 3 3 3 3 55926 55953 55980 56007 3 0 3 0 55539 0
                55566 0 2 2 2 3 55593 55611 55629 55647 2 0 2 0 55674 0 55692 0
                3 0 3 0 55269 0 55296 0 3 0 3 0 55323 0 55350 0 2 2 0 0 55377
                55395 46 47 2 0 3 0 55494 0 55512 0 2 0 2 0 55413 0 55431 0 2 0
                3 0 55449 0 55467 0))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh4-simd) 0 64))
            #(-3.0 3.434 0.0 3.15 -2.0 2.0 0.0 0.0 -3.0 0.6049 0.0 3.15 -2.0
                   2.0 0.0 0.0 0.310439 3.434 0.002175 2.5974 -1.97424 1.97424
                   0.0 0.0 -3.0 0.6049 0.0 2.435437 -2.0 2.0 0.0 0.0 -1.480325
                   0.557774 2.4 3.15 -1.480325 1.480325 0.0 0.0 -3.0 -1.55
                   0.3168 2.24955 -1.18784 1.18784 0.0 0.0 -1.79295 0.6049 0.0
                   2.435437 -2.0 2.0 0.0 0.0 -3.0 -1.989107 0.703463 2.2464
                   -0.225 0.225 0.0 0.0 -2.158645 -1.55 0.3168 2.24955 -1.18784
                   1.18784 0.0 0.0 -3.0 -2.11305 0.703463 1.8 -0.225 0.225 0.0
                   0.0 -3.0 -1.989107 1.8 2.2464 -0.225 0.225 0.0 0.0 -2.8288
                   -2.11305 0.703463 1.285171 -0.225 0.225 0.0 0.0 -3.0 -2.4624
                   1.163194 1.8 -0.225 0.225 0.0 0.0 -2.8288 -2.374406 0.922987
                   1.285171 -0.225 0.225 0.0 0.0 -2.46835 -2.11305 0.703463
                   1.2492 -0.225 0.225 0.0 0.0 -2.8288 -2.381752 0.922987
                   1.285171 -0.225 0.081 0.0 0.0 -2.725825 -2.374406 0.929375
                   1.253906 0.081 0.225 0.0 0.0 -2.725825 -2.381752 0.929375
                   1.28235 -0.225 -0.081 0.0 0.0 -2.8288 -2.465644 0.922987
                   1.285171 -0.081 0.081 0.0 0.0 -2.725825 -2.514778 1.044497
                   1.28235 -0.225 -0.081 0.0 0.0 -2.607034 -2.381752 0.929375
                   1.243303 -0.225 -0.081 0.0 0.0 -2.725825 -2.579059 1.044497
                   1.199325 -0.189 -0.081 0.0 0.0 -2.6894 -2.514778 1.08409
                   1.28235 -0.225 -0.189 0.0 0.0 -2.725825 -2.595725 1.044497
                   1.1778 -0.144 -0.081 0.0 0.0))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh4-simd) 0 64))
            #(-3.0 3.434 0.0 3.15 -2.0 2.0 0.0 0.0 -3.0 0.6049 0.0 3.15 -2.0
                   2.0 0.0 0.0 0.310439 3.434 0.002175 2.5974 -1.97424 1.97424
                   0.0 0.0 -3.0 0.6049 0.0 2.435437 -2.0 2.0 0.0 0.0 -1.480325
                   0.557774 2.4 3.15 -1.480325 1.480325 0.0 0.0 -3.0 -1.55
                   0.3168 2.24955 -1.18784 1.18784 0.0 0.0 -1.79295 0.6049 0.0
                   2.435437 -2.0 2.0 0.0 0.0 -3.0 -1.989107 0.703463 2.2464
                   -0.225 0.225 0.0 0.0 -2.158645 -1.55 0.3168 2.24955 -1.18784
                   1.18784 0.0 0.0 -3.0 -2.11305 0.703463 1.8 -0.225 0.225 0.0
                   0.0 -3.0 -1.989107 1.8 2.2464 -0.225 0.225 0.0 0.0 -2.8288
                   -2.11305 0.703463 1.285171 -0.225 0.225 0.0 0.0 -3.0 -2.4624
                   1.163194 1.8 -0.225 0.225 0.0 0.0 -2.8288 -2.374406 0.922987
                   1.285171 -0.225 0.225 0.0 0.0 -2.46835 -2.11305 0.703463
                   1.2492 -0.225 0.225 0.0 0.0 -2.8288 -2.381752 0.922987
                   1.285171 -0.225 0.081 0.0 0.0 -2.725825 -2.374406 0.929375
                   1.253906 0.081 0.225 0.0 0.0 -2.725825 -2.381752 0.929375
                   1.28235 -0.225 -0.081 0.0 0.0 -2.8288 -2.465644 0.922987
                   1.285171 -0.081 0.081 0.0 0.0 -2.725825 -2.514778 1.044497
                   1.28235 -0.225 -0.081 0.0 0.0 -2.607034 -2.381752 0.929375
                   1.243303 -0.225 -0.081 0.0 0.0 -2.725825 -2.579059 1.044497
                   1.199325 -0.189 -0.081 0.0 0.0 -2.6894 -2.514778 1.08409
                   1.28235 -0.225 -0.189 0.0 0.0 -2.725825 -2.595725 1.044497
                   1.1778 -0.144 -0.081 0.0 0.0)))))


(subtest "gpu bvh" (veq:fvprogn
  (let* ((msh (gmsh/io:obj/load-model :teapot))
         (bvh (gmsh:make-bvh msh :num 7
                :matfx (lambda (&rest rest) (declare (ignore rest)) (values :c :m))
                :mode :bvh2-stackless)))
   (veq:mvb (norms mima polyfx nodes mats matpar)
            (gmsh/bvh::gpu/pack-bvh bvh)

     (is-arr (i3.@$identity (?@ nodes 0 64))
             #(0 4 0 -4 0 12 1 8 0 6684 0 -4 0 20 0 16 0 3844 1 8 0 28 0 24 0
                 1580 1 16 0 36 1 32 0 1164 1 24 0 44 1 40 0 628 0 32 0 52 0 48
                 0 268 1 40 0 60 2 56 0 148 0 48 0 68 2 64 0 116 0 56 0 76 0 72
                 0 108 0 64 0 84 1 80 0 92 2 72 4 9 0 88 6 45 0 80 0 100 1 96 7
                 171 0 72 4 99 0 104 4 135 0 96 7 234 0 112 4 297 0 64 0 124 0
                 120 0 132 1 56 4 333 0 128 5 369 0 120 0 140 0 136 7 495 0 56
                 4 414 0 144 5 450 0 136 0 156 2 152 0 212 2 48 0 164 2 160 0
                 188 2 152 0 172 1 168 0 180 1 160 6 558 0 176 6 612 0 168 4
                 666 0 184 7 702 0 160 0 196 1 192))

     (is-arr (f3.@$identity (?@ norms 0 64))
             #(0.0 0.0 0.0 0.0 -0.58975273 -0.58008444 -0.5618663 0.0
                   -0.6111061 -0.58515316 -0.5330525 0.0 -0.6713804 -0.671913
                   -0.3127 0.0 -0.68170005 -0.67052436 -0.29271513 0.0
                   0.16295193 0.1445382 -0.9759895 0.0 0.18052655 0.15299878
                   -0.97159743 0.0 -0.15979487 -0.14774062 -0.9760319 0.0
                   -0.17610748 -0.15620716 -0.9718979 0.0 -0.4249416
                   -0.40689483 -0.8086169 0.0 -0.4541391 -0.41988078
                   -0.78578484 0.0 -0.15236183 -0.17330576 -0.9730113 0.0
                   -0.17011267 -0.1859032 -0.9677302 0.0 -0.39605165
                   -0.46601453 -0.79118484 0.0 -0.4259556 -0.48450828
                   -0.76407695 0.0 0.42447305 0.44398168 -0.7891153 0.0
                   0.46220988 0.4625863 -0.7565553 0.0 0.15612257 0.1706145
                   -0.97289073 0.0 0.17545022 0.18351385 -0.96723306 0.0
                   0.6892307 0.66302586 -0.29216072 0.0 0.59733886 0.5978253
                   -0.5345944 0.0 0.62692904 0.6030929 -0.49319255 0.0
                   -0.5371831 -0.6487638 -0.53901756 0.0 -0.55814296
                   -0.65673953 -0.507119 0.0 -0.60302156 -0.7406165 -0.29639864
                   0.0 -0.6131259 -0.7404811 -0.27525333 0.0 -0.7786614
                   -0.61962765 -0.0987322 0.0 -0.7808237 -0.6177404 -0.09333335
                   0.0 -0.70151466 -0.70643985 -0.093914144 0.0 -0.7041142
                   -0.7046729 -0.087517485 0.0 -0.7790668 -0.6199503 0.09336254
                   0.0 -0.7037023 -0.7042606 0.09391588 0.0 -0.7019224
                   -0.7068505 0.08756326 0.0 -0.6266334 -0.77426153
                   -0.088598624 0.0 -0.62926877 -0.77285266 -0.08197304 0.0
                   -0.6289116 -0.7724141 0.08858131 0.0 -0.62698656 -0.7746979
                   0.08204242 0.0 -0.6771745 -0.666073 0.31270027 0.0
                   -0.67577875 -0.6763149 0.2931233 0.0 -0.59751594 -0.5721401
                   0.5618099 0.0 -0.60276246 -0.59288085 0.53401285 0.0
                   -0.43212104 -0.39952365 0.80848765 0.0 -0.44574717
                   -0.42681676 0.7868525 0.0 -0.16295505 -0.14454097 0.9759885
                   0.0 -0.17209537 -0.15911323 0.97214514 0.0 0.17610781
                   0.15620744 0.9718977 0.0 -0.6091352 -0.7356614 0.29623723
                   0.0 -0.6068921 -0.74537015 0.27587175 0.0))
     (is-arr (f3.@$identity (?@ polyfx 0 64))
             #(0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.11537504
                   -0.11729801 0.0 0.0 0.021700144 0.021524906 -0.045 0.0
                   -2.7111 1.1778 -0.144 0.0 0.0936749 -0.13882291 0.045 0.0
                   0.11034107 -0.11523497 0.0 0.0 -2.6894 1.199325 -0.189 0.0
                   0.1187911 -0.11869693 0.0 0.0 0.01472497 0.014606118
                   -0.06299999 0.0 -2.725825 1.163194 -0.081 0.0 0.10406613
                   -0.13330305 0.06299999 0.0 0.11537504 -0.11729801 0.0 0.0
                   -2.7111 1.1778 -0.144 0.0 0.09757519 -0.110005975 0.0 0.0
                   0.02867508 0.028443933 0.008999988 0.0 -2.634375 1.253906
                   -0.225 0.0 0.06890011 -0.1384499 -0.008999988 0.0 0.09092212
                   -0.10728097 0.0 0.0 -2.6057 1.28235 -0.216 0.0 0.10422802
                   -0.11273205 0.0 0.0 0.02867484 0.028442979 -0.008999988 0.0
                   -2.66305 1.225463 -0.216 0.0 0.07555318 -0.14117503
                   0.008999988 0.0 0.09757519 -0.110005975 0.0 0.0 -2.634375
                   1.253906 -0.225 0.0 0.11034107 -0.11523497 0.0 0.0
                   0.026350021 0.026138067 -0.02700001 0.0 -2.6894 1.199325
                   -0.189 0.0 0.08399105 -0.14137304 0.02700001 0.0 0.10422802
                   -0.11273205 0.0 0.0 -2.66305 1.225463 -0.216 0.0 0.12449288
                   -0.109447956 0.0 0.0 0.022022009 0.031169057 -0.008999988
                   0.0 -2.558822 1.112731 -0.216 0.0 0.102470875 -0.14061701
                   0.008999988 0.0 0.1167748 -0.10685599 0.0 0.0 -2.5368 1.1439
                   -0.225 0.0 0.13158488 -0.111829996 0.0 0.0 0.020236969
                   0.028640985 -0.02700001 0.0 -2.579059 1.08409 -0.189 0.0
                   0.111347914 -0.14047098 0.02700001 0.0 0.12449288
                   -0.109447956 0.0 0.0 -2.558822 1.112731 -0.216 0.0
                   0.10905695 -0.104264975 0.0 0.0 0.020236969 0.028640985
                   0.02700001 0.0 -2.514778 1.175069 -0.216 0.0))
     (is-arr (3.@$identity (?@ mats 0 64))
             #(0 0 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0
                 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0
                 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2
                 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0
                 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0
                 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0
                 0 0 2 0 0))
     (is-arr (3.@$identity (?@ matpar 0 16))
             #(0.7 0.4 0.3 1.0 0.0 1.0 1.0 1.0 1.0 0.0 1.0 1.0 1.0 1.0 0.0 1.0
                   1.0 0.0 0.0 1.0 0.0 1.0 0.0 1.0 0.0 0.0 1.0 1.0 0.0 0.0 0.0
                   1.0 1.0 1.0 1.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
                   0.0 0.0))
     (is-arr (f3.@$identity (?@ mima 0 64))
             #(-3.0 0.0 -2.0 0.0 3.434 3.15 2.0 0.0 -3.0 0.0 -2.0 0.0 0.6049
                    3.15 2.0 0.0 0.310439 0.002175 -1.97424 0.0 3.434 2.5974
                    1.97424 0.0 -3.0 0.0 -2.0 0.0 0.6049 2.435437 2.0 0.0
                    -1.480325 2.4 -1.480325 0.0 0.557774 3.15 1.480325 0.0 -3.0
                    0.3168 -1.18784 0.0 -1.55 2.24955 1.18784 0.0 -1.79295 0.0
                    -2.0 0.0 0.6049 2.435437 2.0 0.0 -3.0 0.703463 -0.225 0.0
                    -1.989107 2.2464 0.225 0.0 -2.158645 0.3168 -1.18784 0.0
                    -1.55 2.24955 1.18784 0.0 -3.0 0.703463 -0.225 0.0 -2.11305
                    1.8 0.225 0.0 -3.0 1.8 -0.225 0.0 -1.989107 2.2464 0.225
                    0.0 -2.8288 0.703463 -0.225 0.0 -2.11305 1.285171 0.225 0.0
                    -3.0 1.163194 -0.225 0.0 -2.4624 1.8 0.225 0.0 -2.8288
                    0.922987 -0.225 0.0 -2.374406 1.285171 0.225 0.0 -2.46835
                    0.703463 -0.225 0.0 -2.11305 1.2492 0.225 0.0 -2.8288
                    0.922987 -0.225 0.0 -2.381752 1.285171 0.081 0.0 -2.725825
                    0.929375 0.081 0.0 -2.374406 1.253906 0.225 0.0 -2.725825
                    0.929375 -0.225 0.0 -2.381752 1.28235 -0.081 0.0 -2.8288
                    0.922987 -0.081 0.0 -2.465644 1.285171 0.081 0.0 -2.725825
                    1.044497 -0.225 0.0 -2.514778 1.28235 -0.081 0.0 -2.607034
                    0.929375 -0.225 0.0 -2.381752 1.243303 -0.081 0.0 -2.725825
                    1.044497 -0.189 0.0 -2.579059 1.199325 -0.081 0.0 -2.6894
                    1.08409 -0.225 0.0 -2.514778 1.28235 -0.189 0.0 -2.579059
                    0.97226 -0.225 0.0 -2.392576 1.20371 -0.189 0.0))))))

(unless (finalize) (error "error in gmsh"))

