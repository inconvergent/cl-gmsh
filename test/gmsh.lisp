(in-package #:gmsh-tests)

(plan 3)

(subtest "gmsh" (veq:fvprogn
  (let ((msh (gmsh:gmsh :max-verts 100)))
    (gmsh:add-vert! msh 1f0 2f0 3f0)
    (gmsh:add-vert! msh 3f0 3f0 4.330)
    (gmsh:add-vert! msh 4f0 2f0 4.0)
    (gmsh:add-vert! msh 9f0 7f0 4.30)
    (is (gmsh:add-poly! msh '(2 0 1)) '(0 1 2))
    ; (is-warning (gmsh:add-poly! msh '(2 0 1))) ; TODO
    (is-error (gmsh:add-poly! msh '(3 3 1)) 'simple-error)
    (is (gmsh:add-poly! msh '(1 2 3)) '(1 2 3))
    (is (gmsh:add-poly! msh '(1 0 3)) '(0 3 1))
    (is (gmsh:get-all-polys msh) '((0 1 2) (1 2 3) (0 3 1)))
    (is (gmsh:del-poly! msh '(1 0 3)) nil) ; only delets literal poly matches
    (is (gmsh:del-poly! msh '(0 3 1)) '(0 3 1))
    (is (gmsh:get-all-polys msh) '((0 1 2) (1 2 3)))

    (is (gmsh:get-connected-verts msh) '(0 1 2 3))
    (is (veq:lst (gmsh:get-vert msh 2)) '(4.0 2.0 4.0))
    (is-arr (gmsh:get-verts msh '(2 3)) #(4.0 2.0 4.0 9.0 7.0 4.3)))))


(subtest "gmsh bvh nodes" (veq:fvprogn
   (let* ((msh (gmsh/io:obj/load-model :cube))
         (lmsh (gmsh/io:obj/load-model :teapot))
         (bvh (gmsh:make-bvh msh :num 2 :mode :bvh2-stackless :sort-num 7))
         (bvh4-simd (gmsh:make-bvh lmsh :num 3 :mode :bvh4-simd :sort-num 7)))

(is-arr (gmsh:get-verts msh (list 2 1 2 4 7 6))
        #(-1.0 -1.0 1.0 1.0 -1.0 1.0 -1.0 -1.0 1.0 1.0 1.0 -1.0 -1.0 1.0 -1.0
               -1.0 1.0 1.0))
    (is (gmsh:get-all-polys msh)
        '((1 2 3) (5 7 6) (1 4 5) (2 5 6) (2 6 7) (0 3 7)
          (0 1 3) (4 7 5) (0 4 1) (1 5 2) (2 7 3) (0 7 4)))
    (is (gmsh:add-poly! msh '(7 6 0)) '(0 7 6))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh) 0 26))
            #(-1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 -1.0 -1.0 1.0 -1.0 1.0
                   0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0
                   -1.0 1.0 0.0 0.0 1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0
                   -1.0 -1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0
                   0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 1.0 1.0 -1.0
                   1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 -1.0))

    (is-arr (gmsh/bvh::bvh-int-nodes bvh)
            #(0 4 0 0 2 9 0 8 0 12 0 0 0 20 1 16 2 99 0 0 2 27 0 24 0 28 1 16 0
                36 2 32 2 81 0 16 2 45 0 40 2 63 0 32))

    (is-arr (p3.@$identity (?@ (gmsh/bvh::bvh-int-nodes bvh4-simd) 0 128))
            #(0 4 0 0 0 12 1 8 0 15508 0 0 0 20 0 16 0 8692 1 8 0 28 0 24 0
                3084 2 16 0 36 1 32 0 2252 1 24 0 44 1 40 0 1236 0 32 0 52 0 48
                0 572 1 40 0 60 2 56 0 340 0 48 0 68 0 64 0 204 1 56 0 76 2 72
                0 148 1 64 0 84 1 80 0 124 0 72 0 92 1 88 0 100 1 80 2 9 0 96 3
                27 0 88 0 108 1 104 0 116 1 80 2 54 0 112 2 72 0 104 2 90 0 120
                2 108 0 80 0 132 1 128 0 140 1 72 2 126 0 136 2 144 0 128 2 162
                0 144 2 180 0 72 0 156 1 152 0 172 1 64 0 164 1 160 3 234 0 152
                2 198 0 168 2 216 0 160 0 180 1 176 0 188 1 64 3 261 0 184 2
                288 0 176 2 306 0 192 0 196 1 64 2 324 0 200 2 342 0 64 0 212 0
                208 0 268 2 56 0 220 0 216 0 244 0 208 0 228 0 224 0 236 0 216
                2 360 0 232 2 378 0 224 2 396 0 240 3 414 0 216 0 252 0 248 0
                260 0 208 2 441 0 256 2 459 0 248 2 477 0 264 2 495 0 208 0 276
                0 272 0 300 0 56 0 284 0 280 0 292 0 272 2 513 0 288 2 531 0
                280 2 549 0 296 2 567 0 272 0 308 0 304 0 324 0 56 0 316 0 312
                3 621 0 304 2 585 0 320 2 603 0 312 3 648 0 328 0 332 0 56 2
                675 0 336 2 693 0 56 0 348 2 344 0 428 2 48 0 356 1 352 0 396 0
                344 0 364 1 360 0 380 1 352 3 711 0 368 0 372 1 360 2 738 0 376
                2 756 0 360 2 774 0 384))

    (is-arr (p3.@$identity (?@ (gmsh/bvh::bvh-simd-nodes bvh4-simd) 0 128))
            #(0 0 0 0 1 2 3 4 0 0 0 0 919 920 921 922 0 0 0 0 505 506 507 508 0
                0 0 0 210 211 212 213 0 0 0 0 5 6 7 8 0 0 0 0 179 180 181 182 0
                0 0 0 121 122 123 124 0 0 0 0 96 97 98 99 0 0 0 0 9 10 11 12 0
                0 0 0 71 72 73 74 0 0 0 0 53 54 55 56 0 0 0 0 34 35 36 37 0 0 0
                0 13 14 15 16 0 0 0 0 30 31 32 33 0 0 3 0 25 26 56313 27 0 0 0
                0 21 22 23 24 0 0 3 0 17 18 56799 19 3 0 3 0 56655 0 56682 0 2
                0 2 0 56709 0 56727 20 2 0 2 3 56826 0 56844 56862 3 0 3 0
                56745 0 56772 0 2 0 2 2 56412 0 56430 56448 3 0 3 0 56466 0
                56493 0 2 0 3 0 56520 0 56538 0 3 2 2 3 56565 56592 56610 56628
                2 0 2 0 56187 0 56205 0 2 0 3 0 56223 0 56241 29 2 0 2 0 56340
                0 56358 28 2 0 2 0 56376 0 56394 0 2 0 3 0 56268 0 56286 0 2 0
                2 0 55989 0 56007 0 2 0 2 0 56025 0 56043 0 2 2 2 2 56061 56079
                56097 56115 3 0 3 0 56133 0 56160 0 3 0 2 0 55089 49 55152 50 0
                0 0 0 45 46 47 48 0 0 3 0 42 43 55674 44 0 0 0 0 38 39 40 41 2
                0 2 2 55737 0 55755 55773 2 0 2 0 55791 0 55809 0 2 2 2 3 55827
                55845 55863 55881 2 2 3 2 55908 55926 55944 55971 2 0 2 2 55539
                0 55557 55575 2 2 2 3 55593 55611 55629 55647 2 0 2 0 55701 0
                55719 0 3 0 3 0 55269 0 55296 0 2 2 2 0 55323 55341 55359 0 3 2
                2 3 55377 55404 55422 55440))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh4-simd) 0 64))
            #(-3.0 3.434 0.0 3.15 -2.0 2.0 0.0 0.0 -3.0 0.667871 0.0 3.15 -2.0
                   2.0 0.0 0.0 0.368768 3.434 0.002175 2.5974 -1.89952 1.89952
                   0.0 0.0 -3.0 0.667871 0.0 2.4 -2.0 2.0 0.0 0.0 -1.5 0.601848
                   2.4 3.15 -1.5 1.5 0.0 0.0 -3.0 -1.785 0.553725 2.24955
                   -0.63808 0.63808 0.0 0.0 -1.914272 0.667871 0.0 2.4 -2.0 2.0
                   0.0 0.0 -3.0 -2.149624 0.8112 2.23785 -0.225 0.225 0.0 0.0
                   -2.3024 -1.785 0.553725 2.24955 -0.63808 0.63808 0.0 0.0
                   -3.0 -2.2648 0.8112 1.8 -0.225 0.225 0.0 0.0 -3.0 -2.149624
                   1.8 2.23785 -0.225 0.225 0.0 0.0 -2.8288 -2.2648 0.8112
                   1.390819 -0.225 0.225 0.0 0.0 -3.0 -2.5375 1.2804 1.8 -0.225
                   0.225 0.0 0.0 -2.8288 -2.434329 0.922987 1.390819 -0.225
                   0.225 0.0 0.0 -2.558822 -2.2648 0.8112 1.2492 -0.225 0.225
                   0.0 0.0 -2.8288 -2.447474 0.922987 1.390819 -0.225 0.0 0.0
                   0.0 -2.8288 -2.434329 0.922987 1.3656 0.0 0.225 0.0 0.0
                   -2.8288 -2.558822 1.0386 1.390819 -0.225 0.0 0.0 0.0
                   -2.634375 -2.447474 0.922987 1.35 -0.225 0.0 0.0 0.0
                   -2.804755 -2.558822 1.060502 1.390819 -0.225 -0.144 0.0 0.0
                   -2.8288 -2.595725 1.0386 1.298122 -0.144 0.0 0.0 0.0 -2.7111
                   -2.558822 1.060502 1.253906 -0.225 -0.144 0.0 0.0 -2.804755
                   -2.6057 1.1778 1.390819 -0.225 -0.144 0.0 0.0 -2.7111
                   -2.579059 1.060502 1.199325 -0.189 -0.144 0.0 0.0))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh4-simd) 0 64))
            #(-3.0 3.434 0.0 3.15 -2.0 2.0 0.0 0.0 -3.0 0.667871 0.0 3.15 -2.0
                   2.0 0.0 0.0 0.368768 3.434 0.002175 2.5974 -1.89952 1.89952
                   0.0 0.0 -3.0 0.667871 0.0 2.4 -2.0 2.0 0.0 0.0 -1.5 0.601848
                   2.4 3.15 -1.5 1.5 0.0 0.0 -3.0 -1.785 0.553725 2.24955
                   -0.63808 0.63808 0.0 0.0 -1.914272 0.667871 0.0 2.4 -2.0 2.0
                   0.0 0.0 -3.0 -2.149624 0.8112 2.23785 -0.225 0.225 0.0 0.0
                   -2.3024 -1.785 0.553725 2.24955 -0.63808 0.63808 0.0 0.0
                   -3.0 -2.2648 0.8112 1.8 -0.225 0.225 0.0 0.0 -3.0 -2.149624
                   1.8 2.23785 -0.225 0.225 0.0 0.0 -2.8288 -2.2648 0.8112
                   1.390819 -0.225 0.225 0.0 0.0 -3.0 -2.5375 1.2804 1.8 -0.225
                   0.225 0.0 0.0 -2.8288 -2.434329 0.922987 1.390819 -0.225
                   0.225 0.0 0.0 -2.558822 -2.2648 0.8112 1.2492 -0.225 0.225
                   0.0 0.0 -2.8288 -2.447474 0.922987 1.390819 -0.225 0.0 0.0
                   0.0 -2.8288 -2.434329 0.922987 1.3656 0.0 0.225 0.0 0.0
                   -2.8288 -2.558822 1.0386 1.390819 -0.225 0.0 0.0 0.0
                   -2.634375 -2.447474 0.922987 1.35 -0.225 0.0 0.0 0.0
                   -2.804755 -2.558822 1.060502 1.390819 -0.225 -0.144 0.0 0.0
                   -2.8288 -2.595725 1.0386 1.298122 -0.144 0.0 0.0 0.0 -2.7111
                   -2.558822 1.060502 1.253906 -0.225 -0.144 0.0 0.0 -2.804755
                   -2.6057 1.1778 1.390819 -0.225 -0.144 0.0 0.0 -2.7111
                   -2.579059 1.060502 1.199325 -0.189 -0.144 0.0 0.0)))))


(subtest "gpu bvh" (veq:fvprogn
  (let* ((msh (gmsh/io:obj/load-model :teapot))
         (bvh (gmsh:make-bvh msh :num 7
                :matfx (lambda (&rest rest) (declare (ignore rest)) (values :c :m))
                :mode :bvh2-stackless)))
   (veq:mvb (norms mima polyfx nodes mats matpar)
            (gmsh/bvh::gpu/pack-bvh bvh)

     (is-arr (i3.@$identity (?@ nodes 0 64))
             #(0 4 0 -4 0 12 1 8 0 7028 0 -4 0 20 0 16 0 3876 1 8 0 28 0 24 0
                 1380 2 16 0 36 1 32 0 1044 1 24 0 44 1 40 0 572 0 32 0 52 0 48
                 0 268 1 40 0 60 2 56 0 180 0 48 0 68 0 64 0 124 1 56 0 76 2 72
                 0 108 1 64 0 84 1 80 0 100 0 72 5 9 0 88 0 92 1 80 4 54 0 96 4
                 90 0 80 4 126 0 104 4 162 0 72 7 198 0 112 0 116 1 64 5 261 0
                 120 6 306 0 64 0 132 0 128 0 156 2 56 0 140 0 136 0 148 0 128
                 4 360 0 144 5 396 0 136 4 441 0 152 4 477 0 128 0 164 0 160 0
                 172 0 56 4 513 0 168 4 549 0 160 7 585 0 176 7 648 0 56 0 188
                 2 184 0 212 2 48 0 196 1 192))

     (is-arr (f3.@$identity (?@ norms 0 64))
             #(0.0 0.0 0.0 0.0 -0.15979487 -0.14774062 -0.9760319 0.0
                   -0.4249416 -0.40689483 -0.8086169 0.0 -0.4541391 -0.41988078
                   -0.78578484 0.0 -0.58975273 -0.58008444 -0.5618663 0.0
                   -0.6111061 -0.58515316 -0.5330525 0.0 -0.45297384
                   -0.34376627 -0.82258093 0.0 -0.47761306 -0.35064355
                   -0.8055649 0.0 -0.64205277 -0.49975377 -0.58139014 0.0
                   -0.6607656 -0.50146145 -0.5585026 0.0 0.16927049 0.11945805
                   -0.97830325 0.0 0.18326896 0.12381709 -0.9752342 0.0
                   -0.1669708 -0.12258299 -0.9783119 0.0 -0.18008336
                   -0.12708895 -0.97540677 0.0 -0.7410744 -0.5862931
                   -0.32721415 0.0 -0.7500775 -0.58383685 -0.31067398 0.0
                   -0.7786614 -0.61962765 -0.0987322 0.0 -0.7808237 -0.6177404
                   -0.09333335 0.0 -0.6713804 -0.671913 -0.3127 0.0 -0.68170005
                   -0.67052436 -0.29271513 0.0 -0.70151466 -0.70643985
                   -0.093914144 0.0 -0.7041142 -0.7046729 -0.087517485 0.0
                   -0.39605165 -0.46601453 -0.79118484 0.0 -0.5371831
                   -0.6487638 -0.53901756 0.0 -0.55814296 -0.65673953 -0.507119
                   0.0 -0.60302156 -0.7406165 -0.29639864 0.0 -0.6131259
                   -0.7404811 -0.27525333 0.0 -0.6266334 -0.77426153
                   -0.088598624 0.0 -0.62926877 -0.77285266 -0.08197304 0.0
                   0.44968116 0.38111106 -0.8078002 0.0 0.48557264 0.39303043
                   -0.7808625 0.0 0.16295193 0.1445382 -0.9759895 0.0
                   0.18052655 0.15299878 -0.97159743 0.0 -0.17610748
                   -0.15620716 -0.9718979 0.0 0.79512566 0.59926146 -0.09306366
                   0.0 0.79904175 0.5953171 -0.08443849 0.0 0.75070614
                   0.58304673 -0.31063947 0.0 0.7656963 0.5770815 -0.28405294
                   0.0 0.64402354 0.52128315 -0.5599085 0.0 0.6730292
                   0.52271783 -0.5232569 0.0 -0.7037023 -0.7042606 0.09391588
                   0.0 -0.7019224 -0.7068505 0.08756326 0.0 -0.6771745
                   -0.666073 0.31270027 0.0 -0.67577875 -0.6763149 0.2931233
                   0.0 -0.59751594 -0.5721401 0.5618099 0.0 -0.60276246
                   -0.59288085 0.53401285 0.0 -0.43212104 -0.39952365
                   0.80848765 0.0 -0.44574717 -0.42681676 0.7868525 0.0))
     (is-arr (f3.@$identity (?@ polyfx 0 64))
             #(0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.10422802
                   -0.11273205 0.0 0.0 0.02867484 0.028442979 -0.008999988 0.0
                   -2.66305 1.225463 -0.216 0.0 0.11034107 -0.11523497 0.0 0.0
                   0.026350021 0.026138067 -0.02700001 0.0 -2.6894 1.199325
                   -0.189 0.0 0.08399105 -0.14137304 0.02700001 0.0 0.10422802
                   -0.11273205 0.0 0.0 -2.66305 1.225463 -0.216 0.0 0.11537504
                   -0.11729801 0.0 0.0 0.021700144 0.021524906 -0.045 0.0
                   -2.7111 1.1778 -0.144 0.0 0.0936749 -0.13882291 0.045 0.0
                   0.11034107 -0.11523497 0.0 0.0 -2.6894 1.199325 -0.189 0.0
                   0.08946109 -0.11788106 0.0 0.0 0.03144312 0.023175001
                   -0.02700001 0.0 -2.778861 1.317206 -0.189 0.0 0.05801797
                   -0.14105606 0.02700001 0.0 0.08436799 -0.11491799 0.0 0.0
                   -2.747418 1.340381 -0.216 0.0 0.09365487 -0.12032199 0.0 0.0
                   0.025893927 0.019083977 -0.045 0.0 -2.804755 1.298122 -0.144
                   0.0 0.067760944 -0.13940597 0.045 0.0 0.08946109 -0.11788106
                   0.0 0.0 -2.778861 1.317206 -0.189 0.0 0.078825 -0.11169398
                   0.0 0.0 0.034218073 0.025218964 0.008999988 0.0 -2.7132
                   1.3656 -0.225 0.0 0.044606924 -0.13691294 -0.008999988 0.0
                   0.073282 -0.10846901 0.0 0.0 -2.678982 1.390819 -0.216 0.0
                   0.08436799 -0.11491799 0.0 0.0 0.034217834 0.025218964
                   -0.008999988 0.0 -2.747418 1.340381 -0.216 0.0 0.050150156
                   -0.14013696 0.008999988 0.0 0.078825 -0.11169398 0.0 0.0
                   -2.7132 1.3656 -0.225 0.0 0.09650087 -0.12197709 0.0 0.0
                   0.017570972 0.012951016 -0.06299999 0.0 -2.822326 1.285171
                   -0.081 0.0 0.0789299 -0.1349281 0.06299999 0.0 0.09365487
                   -0.12032199 0.0 0.0 -2.804755 1.298122 -0.144 0.0))
     (is-arr (3.@$identity (?@ mats 0 64))
             #(0 0 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0
                 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0
                 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2
                 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0
                 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0
                 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0
                 0 0 2 0 0))
     (is-arr (3.@$identity (?@ matpar 0 16))
             #(0.7 0.4 0.3 1.0 0.0 1.0 1.0 1.0 1.0 0.0 1.0 1.0 1.0 1.0 0.0 1.0
                   1.0 0.0 0.0 1.0 0.0 1.0 0.0 1.0 0.0 0.0 1.0 1.0 0.0 0.0 0.0
                   1.0 1.0 1.0 1.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
                   0.0 0.0))
     (is-arr (f3.@$identity (?@ mima 0 64))
             #(-3.0 0.0 -2.0 0.0 3.434 3.15 2.0 0.0 -3.0 0.0 -2.0 0.0 0.667871
                    3.15 2.0 0.0 0.368768 0.002175 -1.89952 0.0 3.434 2.5974
                    1.89952 0.0 -3.0 0.0 -2.0 0.0 0.667871 2.4 2.0 0.0 -1.5 2.4
                    -1.5 0.0 0.601848 3.15 1.5 0.0 -3.0 0.553725 -0.63808 0.0
                    -1.785 2.24955 0.63808 0.0 -1.914272 0.0 -2.0 0.0 0.667871
                    2.4 2.0 0.0 -3.0 0.8112 -0.225 0.0 -2.149624 2.23785 0.225
                    0.0 -2.3024 0.553725 -0.63808 0.0 -1.785 2.24955 0.63808
                    0.0 -3.0 0.8112 -0.225 0.0 -2.2648 1.8 0.225 0.0 -3.0 1.8
                    -0.225 0.0 -2.149624 2.23785 0.225 0.0 -2.8288 0.8112
                    -0.225 0.0 -2.2648 1.390819 0.225 0.0 -3.0 1.2804 -0.225
                    0.0 -2.5375 1.8 0.225 0.0 -2.8288 0.922987 -0.225 0.0
                    -2.434329 1.390819 0.225 0.0 -2.558822 0.8112 -0.225 0.0
                    -2.2648 1.2492 0.225 0.0 -2.8288 0.922987 -0.225 0.0
                    -2.447474 1.390819 0.0 0.0 -2.8288 0.922987 0.0 0.0
                    -2.434329 1.3656 0.225 0.0 -2.8288 1.0386 -0.225 0.0
                    -2.558822 1.390819 0.0 0.0 -2.634375 0.922987 -0.225 0.0
                    -2.447474 1.35 0.0 0.0 -2.804755 1.060502 -0.225 0.0
                    -2.558822 1.390819 -0.144 0.0 -2.8288 1.0386 -0.144 0.0
                    -2.595725 1.298122 0.0 0.0 -2.7111 1.060502 -0.225 0.0
                    -2.558822 1.253906 -0.144 0.0 -2.804755 1.1778 -0.225 0.0
                    -2.6057 1.390819 -0.144 0.0 -2.804755 1.1778 -0.216 0.0
                    -2.66305 1.340381 -0.144 0.0))))))
(unless (finalize) (error "error in gmsh"))

