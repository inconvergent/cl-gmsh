(in-package #:gmsh-tests)

(plan 3)

(subtest "gmsh" (veq:fvprogn
  (let ((msh (gmsh:gmsh :max-verts 100)))
    (gmsh:add-vert! msh 1f0 2f0 3f0)
    (gmsh:add-vert! msh 3f0 3f0 4.330)
    (gmsh:add-vert! msh 4f0 2f0 4.0)
    (gmsh:add-vert! msh 9f0 7f0 4.30)
    (is (gmsh:add-poly! msh '(2 0 1)) '(0 1 2))
    ; (is-warning (gmsh:add-poly! msh '(2 0 1))) ; TODO
    (is-error (gmsh:add-poly! msh '(3 3 1)) 'simple-error)
    (is (gmsh:add-poly! msh '(1 2 3)) '(1 2 3))
    (is (gmsh:add-poly! msh '(1 0 3)) '(0 3 1))
    (is (gmsh:@all-polys msh) '((0 1 2) (1 2 3) (0 3 1)))
    (is (gmsh:del-poly! msh '(1 0 3)) nil) ; only delets literal poly matches
    (is (gmsh:del-poly! msh '(0 3 1)) '(0 3 1))
    (is (gmsh:@all-polys msh) '((0 1 2) (1 2 3)))

    (is (gmsh:@connected-verts msh) '(0 1 2 3))
    (is (veq:lst (gmsh:@vert msh 2)) '(4.0 2.0 4.0))
    (is-arr (gmsh:@verts msh '(2 3)) #(4.0 2.0 4.0 9.0 7.0 4.3)))))


(subtest "gmsh bvh nodes" (veq:fvprogn
   (let* ((msh (gmsh/io:obj/load-model :cube))
         (lmsh (gmsh/io:obj/load-model :teapot))
         (bvh (gmsh:make-bvh msh :num 2 :mode :bvh2-stackless))
         (bvh4-simd (gmsh:make-bvh lmsh :num 3 :mode :bvh4-simd)))

(is-arr (gmsh:@verts msh (list 2 1 2 4 7 6))
        #(-1.0 -1.0 1.0 1.0 -1.0 1.0 -1.0 -1.0 1.0 1.0 1.0 -1.0 -1.0 1.0 -1.0
               -1.0 1.0 1.0))
    (is (gmsh:@all-polys msh)
        '((1 2 3) (5 7 6) (1 4 5) (2 5 6) (2 6 7) (0 3 7)
          (0 1 3) (4 7 5) (0 4 1) (1 5 2) (2 7 3) (0 7 4)))
    (is (gmsh:add-poly! msh '(7 6 0)) '(0 7 6))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh) 0 26))
            #(-1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 -1.0 -1.0 1.0 -1.0 1.0
                   0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0
                   -1.0 1.0 0.0 0.0 1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0
                   -1.0 -1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0
                   0.0 -1.0 1.0 -1.0 1.0 -1.0 1.0 0.0 0.0 -1.0 1.0 1.0 1.0 -1.0
                   1.0 0.0 0.0 -1.0 1.0 -1.0 1.0 -1.0 -1.0))

    (is-arr (gmsh/bvh::bvh-int-nodes bvh)
            #(0 4 0 0 2 9 0 8 0 12 0 0 0 20 1 16 2 99 0 0 2 27 0 24 0 28 1 16 0
                36 2 32 2 81 0 16 2 45 0 40 2 63 0 32))

    (is-arr (p3.@$identity (?@ (gmsh/bvh::bvh-int-nodes bvh4-simd) 0 128))
            #(0 4 0 0 0 12 1 8 0 15644 0 0 0 20 0 16 0 8732 1 8 0 28 1 24 0 2772 1 16 0
        36 0 32 0 1036 1 24 0 44 1 40 0 556 0 32 0 52 2 48 0 276 2 40 0 60 2 56 0
        172 2 48 0 68 0 64 0 132 0 56 0 76 1 72 0 92 1 64 2 9 0 80 0 84 1 72 2 27
        0 88 2 45 0 72 0 100 1 96 0 116 1 64 2 63 0 104 0 108 1 96 2 81 0 112 2
        99 0 96 0 124 1 120 2 153 0 64 2 117 0 128 2 135 0 120 0 140 0 136 0 164
        1 56 0 148 1 144 0 156 1 136 2 171 0 152 2 189 0 144 2 207 0 160 2 225 0
        136 2 243 0 168 2 261 0 56 0 180 0 176 0 220 0 48 0 188 0 184 0 212 0 176
        0 196 0 192 0 204 0 184 2 279 0 200 2 297 0 192 2 315 0 208 2 333 0 184 2
        351 0 216 2 369 0 176 0 228 0 224 0 244 1 48 0 236 0 232 3 423 0 224 2
        387 0 240 2 405 0 232 0 252 0 248 0 268 0 48 0 260 0 256 3 486 0 248 2
        450 0 264 2 468 0 256 3 513 0 272 2 540 0 48 0 284 0 280 0 428 2 40 0 292
        2 288 0 364 2 280 0 300 1 296 0 340 0 288 0 308 1 304 0 324 1 296 0 316 1
        312 3 594 0 304 2 558 0 320 2 576 0 312 2 621 0 328 0 332 1 296 2 639 0
        336 2 657 0 296 0 348 1 344 0 356 1 288 2 675 0 352 2 693 0 344 2 711 0
        360 2 729 0 288 0 372 0 368 0 404 0 280 0 380 1 376 0 388 1 368 3 747 0
        384))

    (is-arr (p3.@$identity (?@ (gmsh/bvh::bvh-simd-nodes bvh4-simd) 0 128))
#(0 0 0 0 1 2 3 4 0 0 0 0 910 911 912 913 0 0 0 0 484 485 486 487 0 0 0 0
        166 167 168 169 0 0 0 0 5 6 7 8 0 0 0 0 142 143 144 145 0 0 0 0 111 112
        113 114 0 0 0 0 91 92 93 94 0 0 0 0 9 10 11 12 0 0 0 0 70 71 72 73 0 0 0
        0 51 52 53 54 0 0 0 0 33 34 35 36 0 0 0 0 13 14 15 16 0 0 0 0 29 30 31 32
        0 0 0 0 25 26 27 28 0 0 3 0 21 22 56556 23 0 0 0 0 17 18 19 20 3 3 2 0
        56655 56682 56709 0 2 3 3 0 56727 56745 56772 0 2 0 2 0 56799 0 56817 0 2
        0 2 2 56835 0 56853 56871 2 2 2 2 56412 56430 56448 56466 2 0 0 2 56484 0
        24 56538 2 3 3 0 56583 56601 56628 0 2 0 2 0 56502 0 56520 0 3 0 2 2
        56187 0 56214 56232 3 0 2 2 56250 0 56277 56295 2 0 2 0 56313 0 56331 0 2
        0 2 3 56349 0 56367 56385 2 0 2 0 55989 0 56007 0 2 0 2 0 56025 0 56043 0
        2 2 2 2 56061 56079 56097 56115 3 0 3 0 56133 0 56160 0 0 3 0 0 48 55125
        49 50 0 0 0 0 44 45 46 47 0 0 0 3 41 42 43 55710 0 0 0 0 37 38 39 40 2 2
        2 0 55737 55755 55773 0 2 0 2 0 55791 0 55809 0 2 2 2 3 55827 55845 55863
        55881 2 2 2 3 55908 55926 55944 55962 2 0 2 2 55539 0 55557 55575 2 2 2 3
        55593 55611 55629 55647 2 0 2 0 55674 0 55692 0 2 2 2 2 55269 55287 55305
        55323 3 0 2 3 55341 0 55368 55386 3 0 3 0 55413 0 55440 0 3 0 2 3 55467 0
        55494 55512))

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh4-simd) 0 64))
            #(-3.0 3.434 0.0 3.15 -2.0 2.0 0.0 0.0 -3.0 0.667871 0.0 3.15 -2.0 2.0 0.0
        0.0 0.368768 3.434 0.002175 2.5974 -1.89952 1.89952 0.0 0.0 -3.0 0.667871
        0.0 2.4 -2.0 2.0 0.0 0.0 -1.5 0.601848 2.4 3.15 -1.5 1.5 0.0 0.0 -3.0
        -1.9 0.6 2.2464 -0.32816 0.32816 0.0 0.0 -2.04 0.667871 0.0 2.4 -2.0 2.0
        0.0 0.0 -2.90415 -1.9 0.6 1.477519 -0.32816 0.32816 0.0 0.0 -3.0 -1.9832
        1.3656 2.2464 -0.225 0.225 0.0 0.0 -2.90415 -2.3717 0.922987 1.477519
        -0.225 0.225 0.0 0.0 -2.46835 -1.9 0.6 1.1784 -0.32816 0.32816 0.0 0.0
        -2.73125 -2.3717 0.922987 1.253906 -0.225 0.225 0.0 0.0 -2.90415 -2.4624
        1.1439 1.477519 -0.225 0.225 0.0 0.0 -2.73125 -2.3717 0.922987 1.253906
        -0.225 0.0 0.0 0.0 -2.73125 -2.3717 0.922987 1.253906 0.0 0.225 0.0 0.0
        -2.7111 -2.381752 0.946711 1.253906 -0.225 -0.144 0.0 0.0 -2.73125
        -2.3717 0.922987 1.2492 -0.144 0.0 0.0 0.0 -2.7111 -2.5368 1.060502
        1.253906 -0.225 -0.144 0.0 0.0 -2.595725 -2.381752 0.946711 1.227298
        -0.225 -0.144 0.0 0.0 -2.7111 -2.579059 1.060502 1.199325 -0.189 -0.144
        0.0 0.0 -2.6894 -2.5368 1.08409 1.253906 -0.225 -0.189 0.0 0.0 -2.6894
        -2.558822 1.08409 1.225463 -0.216 -0.189 0.0 0.0 -2.66305 -2.5368
        1.112731 1.253906 -0.225 -0.216 0.0 0.0 -2.595725 -2.420025 0.946711
        1.1439 -0.225 -0.144 0.0 0.0)
)

    (is-arr (f3.@$identity (?@ (gmsh/bvh::bvh-mima bvh4-simd) 0 64))

#(-3.0 3.434 0.0 3.15 -2.0 2.0 0.0 0.0 -3.0 0.667871 0.0 3.15 -2.0 2.0 0.0
        0.0 0.368768 3.434 0.002175 2.5974 -1.89952 1.89952 0.0 0.0 -3.0 0.667871
        0.0 2.4 -2.0 2.0 0.0 0.0 -1.5 0.601848 2.4 3.15 -1.5 1.5 0.0 0.0 -3.0
        -1.9 0.6 2.2464 -0.32816 0.32816 0.0 0.0 -2.04 0.667871 0.0 2.4 -2.0 2.0
        0.0 0.0 -2.90415 -1.9 0.6 1.477519 -0.32816 0.32816 0.0 0.0 -3.0 -1.9832
        1.3656 2.2464 -0.225 0.225 0.0 0.0 -2.90415 -2.3717 0.922987 1.477519
        -0.225 0.225 0.0 0.0 -2.46835 -1.9 0.6 1.1784 -0.32816 0.32816 0.0 0.0
        -2.73125 -2.3717 0.922987 1.253906 -0.225 0.225 0.0 0.0 -2.90415 -2.4624
        1.1439 1.477519 -0.225 0.225 0.0 0.0 -2.73125 -2.3717 0.922987 1.253906
        -0.225 0.0 0.0 0.0 -2.73125 -2.3717 0.922987 1.253906 0.0 0.225 0.0 0.0
        -2.7111 -2.381752 0.946711 1.253906 -0.225 -0.144 0.0 0.0 -2.73125
        -2.3717 0.922987 1.2492 -0.144 0.0 0.0 0.0 -2.7111 -2.5368 1.060502
        1.253906 -0.225 -0.144 0.0 0.0 -2.595725 -2.381752 0.946711 1.227298
        -0.225 -0.144 0.0 0.0 -2.7111 -2.579059 1.060502 1.199325 -0.189 -0.144
        0.0 0.0 -2.6894 -2.5368 1.08409 1.253906 -0.225 -0.189 0.0 0.0 -2.6894
        -2.558822 1.08409 1.225463 -0.216 -0.189 0.0 0.0 -2.66305 -2.5368
        1.112731 1.253906 -0.225 -0.216 0.0 0.0 -2.595725 -2.420025 0.946711
        1.1439 -0.225 -0.144 0.0 0.0)
))))


(subtest "gpu bvh" (veq:fvprogn
  (let* ((msh (gmsh/io:obj/load-model :teapot))
         (bvh (gmsh:make-bvh msh :num 7
                :matfx (lambda (&rest rest) (declare (ignore rest)) (values :c :m))
                :mode :bvh2-stackless)))
   (veq:mvb (norms mima polyfx nodes mats matpar)
            (gmsh/bvh::gpu/pack-bvh bvh)

     (is-arr (i3.@$identity (?@ nodes 0 64))
#(0 4 0 -4 0 12 1 8 0 6940 0 -4 0 20 0 16 0 3764 1 8 0 28 1 24 0 1212 1 16
        0 36 0 32 0 460 1 24 0 44 1 40 0 260 0 32 0 52 2 48 0 140 2 40 0 60 2 56
        0 100 2 48 0 68 0 64 0 84 0 56 6 9 0 72 0 76 1 64 6 63 0 80 6 117 0 64 0
        92 0 88 4 243 0 56 4 171 0 96 4 207 0 88 0 108 0 104 0 124 0 48 0 116 0
        112 4 351 0 104 4 279 0 120 4 315 0 112 7 387 0 128 0 132 1 48 7 450 0
        136 5 513 0 48 0 148 0 144 0 204 2 40 0 156 2 152 0 180 2 144 0 164 1 160
        0 172 0 152 7 558 0 168 6 621 0 160 4 675 0 176 4 711 0 152 0 188 0 184 0
        196 0 144 5 747 0 192)

             )

     (is-arr (f3.@$identity (?@ norms 0 64))
#(0.0 0.0 0.0 0.0 -0.15979487 -0.14774062 -0.9760319 0.0 -0.17610748
        -0.15620716 -0.9718979 0.0 -0.4249416 -0.40689483 -0.8086169 0.0
        -0.4541391 -0.41988078 -0.78578484 0.0 -0.58975273 -0.58008444 -0.5618663
        0.0 -0.6111061 -0.58515316 -0.5330525 0.0 -0.15236183 -0.17330576
        -0.9730113 0.0 -0.17011267 -0.1859032 -0.9677302 0.0 -0.39605165
        -0.46601453 -0.79118484 0.0 -0.4259556 -0.48450828 -0.76407695 0.0
        -0.5371831 -0.6487638 -0.53901756 0.0 -0.55814296 -0.65673953 -0.507119
        0.0 0.59733886 0.5978253 -0.5345944 0.0 0.62692904 0.6030929 -0.49319255
        0.0 0.42447305 0.44398168 -0.7891153 0.0 0.46220988 0.4625863 -0.7565553
        0.0 0.15612257 0.1706145 -0.97289073 0.0 0.17545022 0.18351385
        -0.96723306 0.0 -0.6713804 -0.671913 -0.3127 0.0 -0.68170005 -0.67052436
        -0.29271513 0.0 -0.70151466 -0.70643985 -0.093914144 0.0 -0.7041142
        -0.7046729 -0.087517485 0.0 -0.60302156 -0.7406165 -0.29639864 0.0
        -0.6131259 -0.7404811 -0.27525333 0.0 -0.6266334 -0.77426153 -0.088598624
        0.0 -0.62926877 -0.77285266 -0.08197304 0.0 0.72776014 0.6802965
        -0.08695901 0.0 0.7320312 0.67681146 -0.07782346 0.0 0.6892307 0.66302586
        -0.29216072 0.0 0.7047189 0.658758 -0.2634563 0.0 -0.7037023 -0.7042606
        0.09391588 0.0 -0.7019224 -0.7068505 0.08756326 0.0 -0.6771745 -0.666073
        0.31270027 0.0 -0.67577875 -0.6763149 0.2931233 0.0 -0.6289116 -0.7724141
        0.08858131 0.0 -0.62698656 -0.7746979 0.08204242 0.0 -0.6091352
        -0.7356614 0.29623723 0.0 -0.6068921 -0.74537015 0.27587175 0.0
        0.69882387 0.65324736 0.29139856 0.0 0.69491076 0.66849 0.26499084 0.0
        0.73148304 0.67630464 0.086859874 0.0 0.728301 0.6808021 0.078013614 0.0
        -0.59751594 -0.5721401 0.5618099 0.0 -0.60276246 -0.59288085 0.53401285
        0.0 -0.43212104 -0.39952365 0.80848765 0.0 -0.44574717 -0.42681676
        0.7868525 0.0 -0.16295505 -0.14454097 0.9759885 0.0)

             )
     (is-arr (f3.@$identity (?@ polyfx 0 64))

#(0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.10422802 -0.11273205
        0.0 0.0 0.02867484 0.028442979 -0.008999988 0.0 -2.66305 1.225463 -0.216
        0.0 0.07555318 -0.14117503 0.008999988 0.0 0.09757519 -0.110005975 0.0
        0.0 -2.634375 1.253906 -0.225 0.0 0.11034107 -0.11523497 0.0 0.0
        0.026350021 0.026138067 -0.02700001 0.0 -2.6894 1.199325 -0.189 0.0
        0.08399105 -0.14137304 0.02700001 0.0 0.10422802 -0.11273205 0.0 0.0
        -2.66305 1.225463 -0.216 0.0 0.11537504 -0.11729801 0.0 0.0 0.021700144
        0.021524906 -0.045 0.0 -2.7111 1.1778 -0.144 0.0 0.0936749 -0.13882291
        0.045 0.0 0.11034107 -0.11523497 0.0 0.0 -2.6894 1.199325 -0.189 0.0
        0.12449288 -0.109447956 0.0 0.0 0.022022009 0.031169057 -0.008999988 0.0
        -2.558822 1.112731 -0.216 0.0 0.102470875 -0.14061701 0.008999988 0.0
        0.1167748 -0.10685599 0.0 0.0 -2.5368 1.1439 -0.225 0.0 0.13158488
        -0.111829996 0.0 0.0 0.020236969 0.028640985 -0.02700001 0.0 -2.579059
        1.08409 -0.189 0.0 0.111347914 -0.14047098 0.02700001 0.0 0.12449288
        -0.109447956 0.0 0.0 -2.558822 1.112731 -0.216 0.0 0.13742709 -0.11379105
        0.0 0.0 0.016666174 0.023587942 -0.045 0.0 -2.595725 1.060502 -0.144 0.0
        0.12076092 -0.13737899 0.045 0.0 0.13158488 -0.111829996 0.0 0.0
        -2.579059 1.08409 -0.189 0.0 0.10196495 -0.10188198 0.0 0.0 0.016665936
        0.023588061 0.045 0.0 -2.494541 1.20371 -0.189 0.0 0.085299015
        -0.12547004 -0.045 0.0 0.09612298 -0.09992206 0.0 0.0 -2.477875 1.227298
        -0.144 0.0 0.10905695 -0.104264975 0.0 0.0 0.020236969 0.028640985
        0.02700001 0.0 -2.514778 1.175069 -0.216 0.0)
             )
     (is-arr (3.@$identity (?@ mats 0 64))
             #(0 0 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0
                 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0
                 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2
                 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0
                 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0
                 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0 0 0 2 0
                 0 0 2 0 0))
     (is-arr (3.@$identity (?@ matpar 0 16))
             #(0.7 0.4 0.3 1.0 0.0 1.0 1.0 1.0 1.0 0.0 1.0 1.0 1.0 1.0 0.0 1.0
                   1.0 0.0 0.0 1.0 0.0 1.0 0.0 1.0 0.0 0.0 1.0 1.0 0.0 0.0 0.0
                   1.0 1.0 1.0 1.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0
                   0.0 0.0))
     (is-arr (f3.@$identity (?@ mima 0 64))
#(-3.0 0.0 -2.0 0.0 3.434 3.15 2.0 0.0 -3.0 0.0 -2.0 0.0 0.667871 3.15 2.0
        0.0 0.368768 0.002175 -1.89952 0.0 3.434 2.5974 1.89952 0.0 -3.0 0.0 -2.0
        0.0 0.667871 2.4 2.0 0.0 -1.5 2.4 -1.5 0.0 0.601848 3.15 1.5 0.0 -3.0 0.6
        -0.32816 0.0 -1.9 2.2464 0.32816 0.0 -2.04 0.0 -2.0 0.0 0.667871 2.4 2.0
        0.0 -2.90415 0.6 -0.32816 0.0 -1.9 1.477519 0.32816 0.0 -3.0 1.3656
        -0.225 0.0 -1.9832 2.2464 0.225 0.0 -2.90415 0.922987 -0.225 0.0 -2.3717
        1.477519 0.225 0.0 -2.46835 0.6 -0.32816 0.0 -1.9 1.1784 0.32816 0.0
        -2.73125 0.922987 -0.225 0.0 -2.3717 1.253906 0.225 0.0 -2.90415 1.1439
        -0.225 0.0 -2.4624 1.477519 0.225 0.0 -2.73125 0.922987 -0.225 0.0
        -2.3717 1.253906 0.0 0.0 -2.73125 0.922987 0.0 0.0 -2.3717 1.253906 0.225
        0.0 -2.7111 0.946711 -0.225 0.0 -2.381752 1.253906 -0.144 0.0 -2.73125
        0.922987 -0.144 0.0 -2.3717 1.2492 0.0 0.0 -2.7111 1.060502 -0.225 0.0
        -2.5368 1.253906 -0.144 0.0 -2.595725 0.946711 -0.225 0.0 -2.381752
        1.227298 -0.144 0.0 -2.595725 0.946711 -0.225 0.0 -2.420025 1.1439 -0.144
        0.0 -2.5368 1.037044 -0.225 0.0 -2.381752 1.227298 -0.144 0.0 -2.73125
        0.922987 -0.144 0.0 -2.458298 1.1778 0.0 0.0 -2.477875 1.127376 -0.144
        0.0 -2.3717 1.2492 0.0 0.0 -2.73125 1.0386 -0.144 0.0 -2.595725 1.1778
        0.0 0.0)

             )))))
(unless (finalize) (error "error in gmsh"))

